#心态——标签映射
MentalTag={
    '喜悦':1,
    '欣慰':1,
    '敬佩':2,
    '赞美':2,
    '感激':2,
    '感动':2,
    '坚定':3,
    '期盼':4,
    '期待':4,
    '祝愿':4,
    '乐观':4,
    '痛快':4,
    '平静':5,
    '理性':6,
    '否认':7,
    '忽视':7,
    '否定':7,
    '疑惑':7,
    '无聊':8,
    '心烦':8,
    '自嘲':8,
    '浮躁':8,
    '急切':9,
    '怜悯':10,
    '惋惜':10,
    '无奈':11,
    '担忧':11,
    '紧张':11,
    '悼念':11,
    '哀伤':11,
    '失望':11,
    '悲观':11,
    '迷惘':11,
    '愤怒':12,
    '诧异':13,
    '感叹':13,
    '震惊':13,
    '恐慌':13,
    '无助':13,
    '悲痛':14,
    '绝望':14
}

#“心态字典”
MentalDic={
    '太棒了':['喜悦','欣慰','赞美','敬佩'],
    '棒极了':['喜悦','欣慰','赞美','敬佩'],
    '太好了':['喜悦','欣慰'],
    '好极了':['喜悦','欣慰'],
    '太强了':['喜悦','赞美','敬佩'],
    '完美':['喜悦','欣慰','赞美'],
    '漂亮！':['喜悦','欣慰','赞美'],
    '哈哈':['喜悦'],
    '开心':['喜悦'],
    '高兴':['喜悦'],
    '好消息':['喜悦'],
    '希望':['期盼'],
    '期待':['期待'],
    '幸好':['怜悯','欣慰'],
    '但愿':['期盼','祝愿'],
    '加油':['期盼','祝愿'],
    '祝':['期盼','祝愿'],
    '坚决反对':['坚定','愤怒'],
    '顶起来':['期盼','祝愿'],
    '感谢':['感激'],
    '谢谢':['感激'],
    '肯定':['坚定'],
    '必然':['坚定'],
    '绝对':['坚定'],
    '一定会的':['坚定','乐观'],
    '一定会好':['坚定','乐观','期盼','祝愿'],
    '滚蛋':['愤怒'],
    '咋就':['诧异','震惊'],
    '关我':['愤怒','浮躁'],
    '噗嗤':['愤怒'],
    '...':['无奈'],
    '。。。':['无奈'],
    '金榜题名':['期盼','祝愿'],
    '善待':['理性'],
    '至上':['坚定','理性'],
    '高人一等':['愤怒'],
    '废青':['自嘲','浮躁','无聊'],
    '渣':['愤怒'],
    '不香了':['失望'],
    '无论':['坚定'],
    '任何':['坚定'],
    '请不要':['理性'],
    '这样才':['理性'],
    '其实':['理性'],
    '确实':['理性'],
    '还不错':['平静'],
    '像狗一样':['愤怒'],
    '得嘞':['失望','愤怒','诧异'],
    '还可以':['平静'],
    '没劲':['无聊','浮躁'],
    '反感':['愤怒'],
    '没事':['乐观'],
    '太难':['无助','担忧','感叹'],
    '有意义吗':['愤怒','诧异'],
    '应该没事':['乐观','否认'],
    '你说的对':['愤怒'],
    '杠精':['愤怒'],
    '懂吗':['愤怒','诧异'],
    '你怕是瞎':['愤怒'],
    '还得靠':['赞美','敬佩'],
    '点赞':['赞美','敬佩','喜悦'],
    '感叹':['震惊'],
    '太伟大了':['敬佩','赞美'],
    '绝不会':['坚定'],
    '不敢想':['担忧','紧张','迷惘'],
    '凭什么':['愤怒'],
    '不要脸':['愤怒'],
    '还行':['平静'],
    '？？':['诧异','震惊'],
    '没脸没皮':['愤怒'],
    '气死了':['愤怒'],
    '有必要吗':['诧异','愤怒'],
    '还不让':['诧异','愤怒'],
    '带节奏':['愤怒'],
    '气愤':['愤怒'],
    '愤怒':['愤怒'],
    'TM':['愤怒'],
    '一定要':['坚定'],
    '绝对不能':['坚定','愤怒'],
    '他妈':['愤怒'],
    '我能信吗':['愤怒','失望'],
    '干嘛':['愤怒','失望'],
    '故意':['愤怒','诧异'],
    '唉':['哀伤','失望','无助','绝望','悲痛','悲观','迷惘','担忧','心烦','无奈','怜悯','惋惜'],
    '啊啊啊':['无助','哀伤','绝望','悲痛'],
    '666':['喜悦','赞美'],
    '还有脸了':['愤怒'],
    '会好':['期盼','祝愿','坚定'],
    '！！':['震惊','诧异','坚定'],
    '！？':['震惊','诧异','愤怒'],
    '？！':['震惊','诧异','愤怒'],
    '怎么办啊':['迷惘','无助','绝望','悲观'],
    '怎么办呀':['迷惘','无助','浮躁','悲观'],
    '那怎么办':['迷惘','无助','浮躁'],
    '哭':['失望','哀伤','无助'],
    '能别':['愤怒','担忧','紧张'],
    '能不能别':['愤怒','担忧','紧张'],
    '稳住':['期盼','祝愿'],
    '坚持住':['期盼','祝愿'],
    '完蛋了':['悲观'],
    '完了':['悲观'],
    '挺住':['期盼','祝愿'],
    '球球':['无助','哀伤','失望','绝望'],
    '求求':['无助','哀伤','失望','绝望'],
    '救救':['无助','哀伤','失望','绝望'],
    '强烈建议':['坚定','愤怒'],
    '有什么用':['愤怒','失望','绝望','无助','迷惘'],
    '有用吗':['愤怒','失望','绝望'],
    '赶紧滚':['愤怒'],
    '恳求':['无助','哀伤','失望','绝望'],
    '终于':['喜悦','欣慰'],
    '太暖了':['赞美','敬佩'],
    '一定能':['乐观','期盼'],
    '绝了':['震惊','赞美'],
    '好棒':['喜悦','欣慰','赞美','敬佩'],
    '好强':['赞美','敬佩'],
    '恭喜':['喜悦','欣慰'],
    '不容易啊':['喜悦','欣慰'],
    '天哪':['震惊'],
    '就为了':['怜悯'],
    '好可怜':['怜悯'],
    '寒心了':['愤怒','失望','绝望'],
    '无语':['愤怒','失望','诧异'],
    '比较担心':['担忧'],
    '拜托了':['无助','哀伤'],
    '醒醒吧':['愤怒','哀伤','失望'],
    '太惨了':['怜悯','哀伤','悲痛','震惊'],
    '这么快':['诧异','震惊'],
    '不服':['诧异','震惊','愤怒'],
    '有心吗':['愤怒','震惊'],
    '实惨':['怜悯','哀伤','悲痛','震惊'],
    '太行了':['愤怒','诧异'],
    '心痛':['悲痛','哀伤'],
    '恐怖':['恐慌','震惊','迷惘'],
    '可怕':['恐慌','震惊'],
    '害怕':['恐慌','震惊'],
    '瑟瑟发抖':['恐慌','震惊'],
    '赶紧的':['急切'],
    '赶快':['急切'],
    '不准吧':['否认','疑惑'],
    '不对吧':['否认','疑惑'],
    '不对啊':['否认','疑惑'],
    '好惨':['怜悯','哀伤','悲痛','震惊'],
    '一定可以':['坚定','乐观','期盼'],
    '咋还':['震惊','诧异'],
    '有毛病啊':['愤怒','震惊'],
    '有病啊':['愤怒','震惊'],
    '保佑':['期盼','怜悯'],
    '干得好':['欣慰','痛快','赞美'],
    '可耻':['愤怒'],
    '严惩':['坚定','愤怒'],
    '脑残':['愤怒'],
    '都不知道吗':['愤怒','诧异','震惊'],
    '妈的':['愤怒'],
    '快哭了':['哀伤','悲痛','无助','失望','绝望',],
    '烦躁':['心烦'],
    '相信':['坚定','乐观','期盼'],
    '快点':['急切'],
    '祝贺':['喜悦','欣慰'],
    '支持':['赞美','敬佩','坚定'],
    '都好好的':['期盼'],
    '铭记':['坚定','敬佩','赞美'],
    '打嘴炮':['愤怒'],
    '坚决':['坚定'],
    '致敬':['敬佩','赞美'],
    '必胜':['坚定','乐观','期盼'],
    '感动':['感动'],
    '放屁':['愤怒'],
    '呵呵':['愤怒'],
    '赞同':['坚定','赞美','喜悦'],
    '千万别':['担忧'],
    '太靠谱了':['赞美','敬佩','喜悦','欣慰'],
    '太离谱了':['震惊','诧异'],
    '不靠谱':['诧异','否定','愤怒'],
    '严格':['坚定'],
    '严控':['坚定'],
    '悲痛':['悲痛','哀伤'],
    '一路走好':['悲痛','悼念','敬佩','惋惜','感动'],
    '辛苦了':['赞美','敬佩'],
    '难受':['哀伤','无助','迷惘','悲痛','心烦'],
    '沉痛':['悲痛','哀伤'],
    '无话可说':['愤怒','震惊','诧异'],
    '悼念':['悲痛','敬佩','惋惜','感动'],
    '泪目':['感动'],
    '这才是':['欣慰','赞美'],
    '就这？':['诧异','愤怒','震惊'],
    '有个屁用':['愤怒'],
    '赞赞赞':['赞美'],
    '不想开学':['心烦','无聊','平静'],
    '还好':['平静'],
    '没意思':['无聊','平静'],
    '无趣':['无聊','平静'],
    '羡慕':['期盼'],
    '不要啊':['愤怒','担忧','紧张'],
    '哇':['震惊','喜悦','欣慰'],
    '如愿以偿':['喜悦','欣慰'],
    '疯了吧':['震惊','愤怒'],
    '太过分了':['震惊','愤怒'],
    '难过':['哀伤','失望','无助','绝望','悲痛','悲观','迷惘','担忧','心烦','无奈','怜悯','惋惜'],
    '不可取':['否认','坚定'],
    '坚决支持':['坚定'],
    '心疼':['怜悯','惋惜']
}

#序号——时间段映射
timeStages={
    0:range(20191208,20200123),
    1:range(20200123,20200207),
    2:range(20200207,20200310),
    3:range(20200310,20200631)
}

#读取停词表
stopWords=[]
with open('stopWords.txt','r',encoding='utf-8') as f:
    for word in f:
        stopWords.append(word.strip())

#读取语料库各文档并排成列表
corList=[]
for corFileNum in range(1200):
    with open('corpus/corpus{}.txt'.format(corFileNum),'r',encoding='utf-8') as f:
        corList.append(f.read())

class news:
    timeStage=-1    #时间段序号
    newsList=[]     #此时间段内新闻项列表
    allComments=[]  #此时间段内新闻评论内容列表
    allTags=[]      #所有可被标签评论的情绪标签
    words=[]        #评论分词后得到的词汇列表(词汇,TF-IDF值)
    keyWords=[]     #评论的关键词(关键词,TF-IDF值)
    sample=[]       #样本新闻项列表

    def __init__(self,newsStr,timeStage):
        self.newsList=[]
        self.allComments=[]
        self.words=[]
        self.sample=[]
        self.timeStage=timeStage
        self.readNews(newsStr)
        self.stractKeyWords()

    def readNews(self,newsStr):#从文件中读取新闻并设置情绪标签
        newsList=newsStr.split('\n\n')
        for news in newsList:
            newsLines=news.split('\n')
            content=newsLines[1].split(':  ')[1]

            comments=[]
            for i in range(4,len(newsLines)):
                commentStr=newsLines[i].strip()[2:]
                oneComment=commentItem(commentStr)
                comments.append(oneComment)

            time=int((newsLines[2].split(':  ')[1]).split(' ')[0].replace('-',''))
            if time in timeStages[self.timeStage]:
                for comment in comments:
                    self.allComments.append(comment.comment)
                    self.allTags+=comment.tag
                item=newsItem(content,comments,time)
                self.newsList.append(item)
        self.allTags.sort()

    def stractKeyWords(self):#对所有评论进行分词，词汇按TF-IDF值降序排序
        import jieba
        commentsText=' '.join(self.allComments)
        wordlist=list(jieba.lcut(commentsText))
        wordlist=[wordlist[i] for i in range(len(wordlist))
                  if len(wordlist[i].strip()) not in range(0,2) and wordlist[i] not in stopWords]
        TF={}
        for word in wordlist:
            if word not in TF.keys():
                TF[word]=1
            else:
                TF[word]+=1
        for word in TF.keys():
            TF[word]/=len(wordlist)

        IDF={}
        for word in wordlist:
            corOccurTime=0
            for corFileNum in range(1200):
                if word in corList[corFileNum]:
                    corOccurTime+=1
            import math
            IDF[word]=math.log(1200/(corOccurTime+1),2)

        TF_IDF={}
        for word in wordlist:
            TF_IDF[word]=TF[word]*IDF[word]
            if TF_IDF[word]<0:
                TF_IDF[word]=0
        self.words=sorted(TF_IDF.items(), key=lambda kv:(kv[1], kv[0]), reverse=True)

        TF_IDFValues=[word_TFIDF[1] for word_TFIDF in self.words]
        average=sum(TF_IDFValues)/len(TF_IDFValues)
        import math
        variance=sum([math.pow(valu-average,2) for valu in TF_IDFValues])/len(TF_IDFValues)
        self.keyWords=[word_TFIDFValue for word_TFIDFValue in self.words
                       if word_TFIDFValue[1]>average+3*math.pow(variance,0.5)]

    def makeSample(self):#系统抽样获取样本
        interval=max(int(len(self.newsList)/20), 1)
        import random
        newsNum=int(random.random()*interval)
        while newsNum<len(self.newsList):
            self.sample.append(self.newsList[newsNum])
            newsNum+=interval

    def writeSample(self):
        with open('sample/timeStage_{}_Sample.txt'.format(self.timeStage),'w',encoding='utf-8') as f:
            for newsItem in self.newsList:
                f.write('内容: '+newsItem.content+'\n')
                f.write('时间: '+str(newsItem.time)+'\n')
                for commentItem in newsItem.comments:
                    f.write('评论：')
                    f.write(commentItem.comment+'\n')
                f.write('\n')

    def printMentalAndKeyWords(self):
        with open('mentalAndKeyWords.txt','a',encoding='utf-8') as f:
            f.write('Time Stage {}:\n'.format(self.timeStage))
            f.write('All Tags:#所有可被标签评论的心态标签')
            i=0
            while i<len(self.allTags):
                f.write('\n  '+str(self.allTags[i:min(i+20,len(self.allTags))]))
                i+=20
            f.write('\n')
            aver=sum(self.allTags)/len(self.allTags)
            f.write('心态标签的均值: {}\n'.format(aver))
            import math
            f.write('心态标签的方差: {}\n'.format(sum([math.pow(tag-aver,2) for tag in self.allTags])/len(self.allTags)))
            f.write('心态标签的频率:\n')
            for i in range(14):
                f.write('  '+str(i+1)+': '+'{}%  '.format(100*self.allTags.count(i+1)/len(self.allTags)))
            f.write('\n')
            f.write('Key Words:#(新闻评论的关键词,TF-IDF值)')
            i=0
            while i<len(self.keyWords):
                f.write('\n  ' + str(self.words[i:min(i + 4, len(self.words))]))
                i+=4
            f.write('\n\n\n')


    def showBarChartOfTags(self):
        import matplotlib.pyplot as plt
        plt.rcParams['font.sans-serif']=['SimHei']
        plt.rcParams['axes.unicode_minus']=False
        mood=('喜悦','感激','坚定','期盼','平静','理性','忽视','无聊','急切','惋惜','哀伤','愤怒','恐慌','绝望')
        fre=[oneNews.allTags.count(i) for i in range(1,15)]
        plt.bar(mood,fre)
        plt.title('第{}时间段心态标签'.format(timeStage+1))
        plt.show()



class newsItem:     #新闻项
    content=''      #新闻内容
    comments=[]     #评论项列表
    time=0          #新闻发布时间

    def __init__(self,content,comments,time):
        self.content=content
        self.comments=comments
        self.time=time

class commentItem:  #评论项
    comment=''      #评论内容
    tag=[]          #心态标签

    def __init__(self,commentStr):
        self.comment=commentStr
        self.tag=[]
        self.setTag()

    def setTag(self):#根据心态字典设置心态标签
        for moodWord in MentalDic.keys():
            if moodWord in self.comment:
                for mentalWord in MentalDic[moodWord]:
                    if MentalTag[mentalWord] not in self.tag:
                        self.tag.append(MentalTag[mentalWord])
        self.tag.sort()

if __name__=='__main__':
    import dataCollect
    #dataCollect.run()
    with open('newsData.txt','r',encoding='utf-8') as f:
        text=f.read()
    newsOfTimeStages=[]
    for timeStage in range(0,4):
        oneNews=news(text,timeStage)
        oneNews.makeSample()
        oneNews.writeSample()
        oneNews.showBarChartOfTags()
        oneNews.printMentalAndKeyWords()
        newsOfTimeStages.append(oneNews)
        print('已完成{}%'.format(25*(timeStage+1)))